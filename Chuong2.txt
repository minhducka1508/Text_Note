2.1 Tá»•ng quan vá» bootloader trong há»‡ thá»‘ng nhÃºng â€“ 3.5â€“4 trang
2.1.1 KhÃ¡i niá»‡m, vai trÃ², vá»‹ trÃ­ khá»Ÿi Ä‘á»™ng
â†’ MÃ´ táº£ luá»“ng khá»Ÿi Ä‘á»™ng trÃªn STM32 (reset â†’ boot ROM â†’ bootloader â†’ á»©ng dá»¥ng)
â†’ HÃ¬nh minh há»a luá»“ng boot process

2.1.2 CÃ¡c loáº¡i bootloader
â†’ MÃ´ táº£ tá»«ng loáº¡i: basic, secure, dual-app, rollback
â†’ Báº£ng so sÃ¡nh Ä‘áº·c Ä‘iá»ƒm cá»§a tá»«ng loáº¡i

2.2 NguyÃªn lÃ½ cáº­p nháº­t firmware tá»« xa (FOTA) â€“ 4â€“4.5 trang
2.2.1 Kiáº¿n trÃºc FOTA tá»•ng quÃ¡t
â†’ MÃ´ hÃ¬nh 3 thÃ nh pháº§n: Tool â†’ Gateway â†’ MCU
â†’ SÆ¡ Ä‘á»“ khá»‘i tá»•ng quÃ¡t há»‡ thá»‘ng FOTA
â†’ PhÃ¢n tÃ­ch vai trÃ² tá»«ng khá»‘i

2.2.2 YÃªu cáº§u triá»ƒn khai ká»¹ thuáº­t
â†’ Giao thá»©c truyá»n, vÃ¹ng nhá»›, kiá»ƒm tra an toÃ n, CRC
â†’ CÃ¡c rÃ ng buá»™c trÃªn vi Ä‘iá»u khiá»ƒn: bá»™ nhá»›, tá»‘c Ä‘á»™ xá»­ lÃ½

2.3 CÆ¡ sá»Ÿ lÃ½ thuyáº¿t vá» cÃ¡c thuáº­t toÃ¡n báº£o máº­t trong FOTA â€“ 7â€“8 trang
2.3.1 AES-128
â†’ NguyÃªn lÃ½ hoáº¡t Ä‘á»™ng, cháº¿ Ä‘á»™ CBC, key size
â†’ SÆ¡ Ä‘á»“ quy trÃ¬nh mÃ£ hÃ³a AES trong FOTA

2.3.2 SHA-256
â†’ Giáº£i thÃ­ch block-wise hash, padding
â†’ Má»¥c Ä‘Ã­ch: kiá»ƒm tra toÃ n váº¹n

2.3.3 RSA & cÆ¡ cháº¿ chá»¯ kÃ½ sá»‘
â†’ KhÃ¡i niá»‡m public-private key
â†’ SÆ¡ Ä‘á»“ xÃ¡c thá»±c chá»¯ kÃ½ sá»‘

ğŸ’¡ NÃªn dÃ¹ng thÃªm báº£ng so sÃ¡nh giá»¯a SHA-256 vÃ  CRC, RSA vÃ  ECDSA, Ä‘á»ƒ kÃ©o ná»™i dung.

2.4 MÃ´ hÃ¬nh phÃ¢n vÃ¹ng flash vÃ  cÆ¡ cháº¿ rollback â€“ 3.5â€“4 trang
2.4.1 PhÃ¢n vÃ¹ng A/B + metadata
â†’ Giáº£i thÃ­ch cÃ¡ch chia vÃ¹ng flash
â†’ HÃ¬nh sÆ¡ Ä‘á»“ phÃ¢n vÃ¹ng bá»™ nhá»›

2.4.2 CÆ¡ cháº¿ rollback
â†’ Khi nÃ o rollback Ä‘Æ°á»£c kÃ­ch hoáº¡t
â†’ Cá» tráº¡ng thÃ¡i (active flag), vÃ­ dá»¥ logic kiá»ƒm tra

2.5 Káº¿t luáº­n chÆ°Æ¡ng â€“ 0.5 trang

==========================================================================
Báº¡n váº«n cÃ³ thá»ƒ giá»¯ 7â€“10 nguá»“n tá»•ng thá»ƒ, trong Ä‘Ã³:

MÃ£	TÃ i liá»‡u	Pháº¡m vi
[1]	ST AN2606	2.1, 2.4
[2]	ST AN4992	2.3, 2.4
[3]	FIPS 197 â€“ AES	2.3.1
[4]	FIPS 180-4 â€“ SHA	2.3.2
[5]	PKCS#1 â€“ RSA	2.3.3
[6]	MCUboot overview	2.1.2
[7]	SÃ¡ch Embedded Systems (Noergaard)	2.1.1, 2.2

======================2.2.1===================================================
\subsubsection{Vai trÃ² vÃ  vá»‹ trÃ­ cá»§a bootloader trong tiáº¿n trÃ¬nh khá»Ÿi Ä‘á»™ng}
Trong há»‡ thá»‘ng nhÃºng, tiáº¿n trÃ¬nh khá»Ÿi Ä‘á»™ng (boot process) Ä‘Ã³ng vai trÃ² khá»Ÿi táº¡o vÃ  Ä‘Æ°a vi Ä‘iá»u khiá»ƒn tá»« tráº¡ng thÃ¡i sau khi cáº¥p nguá»“n vá» tráº¡ng thÃ¡i sáºµn sÃ ng cháº¡y á»©ng dá»¥ng. QuÃ¡ trÃ¬nh nÃ y thÆ°á»ng bao gá»“m cÃ¡c giai Ä‘oáº¡n: thiáº¿t láº­p pháº§n cá»©ng cÆ¡ báº£n, xÃ¡c Ä‘á»‹nh vÃ¹ng khá»Ÿi Ä‘á»™ng vÃ  chuyá»ƒn Ä‘iá»u khiá»ƒn tá»›i chÆ°Æ¡ng trÃ¬nh chÃ­nh. Bootloader lÃ  thÃ nh pháº§n trung gian quan trá»ng trong chuá»—i nÃ y, Ä‘áº·c biá»‡t trong cÃ¡c há»‡ thá»‘ng cÃ³ kháº£ nÄƒng cáº­p nháº­t pháº§n má»m tá»« xa (FOTA).

Bootloader lÃ  má»™t Ä‘oáº¡n mÃ£ nhá» Ä‘Æ°á»£c náº¡p vÃ o vÃ¹ng nhá»› cá»‘ Ä‘á»‹nh (thÆ°á»ng lÃ  flash ná»™i) cá»§a vi Ä‘iá»u khiá»ƒn, vá»›i nhiá»‡m vá»¥ chuáº©n bá»‹ mÃ´i trÆ°á»ng vÃ  quyáº¿t Ä‘á»‹nh cÃ³ chuyá»ƒn quyá»n Ä‘iá»u khiá»ƒn sang á»©ng dá»¥ng chÃ­nh hay khÃ´ng. Trong cÃ¡c vi Ä‘iá»u khiá»ƒn nhÆ° STM32, bootloader cÃ³ thá»ƒ Ä‘Æ°á»£c cÃ i Ä‘áº·t sáºµn tá»« nhÃ  sáº£n xuáº¥t (ROM bootloader) hoáº·c do ngÆ°á»i dÃ¹ng thiáº¿t káº¿ vÃ  náº¡p vÃ o flash (user bootloader).

Vai trÃ² cá»¥ thá»ƒ cá»§a bootloader bao gá»“m:

Kiá»ƒm tra há»£p lá»‡ vÃ¹ng á»©ng dá»¥ng: xÃ¡c minh tÃ­nh toÃ n váº¹n vÃ  chá»¯ kÃ½ sá»‘ (náº¿u cÃ³).

XÃ¡c Ä‘á»‹nh phÃ¢n vÃ¹ng firmware cáº§n khá»Ÿi Ä‘á»™ng: á»©ng dá»¥ng A/B hoáº·c firmware chÃ­nh/phá»¥.

Há»— trá»£ cáº­p nháº­t pháº§n má»m: thÃ´ng qua UART, USB, hoáº·c giao tiáº¿p khÃ´ng dÃ¢y.

Cung cáº¥p kháº£ nÄƒng rollback: trong trÆ°á»ng há»£p firmware má»›i lá»—i hoáº·c khÃ´ng há»£p lá»‡.

Trong cÃ¡c há»‡ thá»‘ng nhÃºng hiá»‡n Ä‘áº¡i, Ä‘áº·c biá»‡t lÃ  nhá»¯ng thiáº¿t bá»‹ triá»ƒn khai ngoÃ i thá»±c Ä‘á»‹a nhÆ° cáº£m biáº¿n mÃ´i trÆ°á»ng, thiáº¿t bá»‹ giÃ¡m sÃ¡t nÄƒng lÆ°á»£ng, há»‡ thá»‘ng Ä‘iá»u khiá»ƒn tá»« xa... bootloader Ä‘Ã³ng vai trÃ² nhÆ° má»™t lá»›p báº£o vá»‡ Ä‘áº§u tiÃªn â€“ khÃ´ng chá»‰ giÃºp thiáº¿t bá»‹ khá»Ÿi Ä‘á»™ng Ä‘Ãºng vÃ¹ng á»©ng dá»¥ng mÃ  cÃ²n Ä‘áº£m báº£o ráº±ng á»©ng dá»¥ng Ä‘Ã³ lÃ  há»£p lá»‡, khÃ´ng bá»‹ thay Ä‘á»•i hoáº·c giáº£ máº¡o.

Má»™t sá»‘ há»‡ thá»‘ng cÃ²n triá»ƒn khai secure boot hai cáº¥p: cáº¥p Ä‘áº§u tiÃªn lÃ  bootloader Ä‘Æ°á»£c náº¡p vÃ o vÃ¹ng bá»™ nhá»› báº£o vá»‡ ROM, khÃ´ng thá»ƒ sá»­a Ä‘á»•i (read-only); cáº¥p hai lÃ  bootloader cá»§a ngÆ°á»i dÃ¹ng cÃ³ kháº£ nÄƒng tÃ¹y biáº¿n, nhÆ°ng pháº£i vÆ°á»£t qua cÃ¡c bÆ°á»›c xÃ¡c thá»±c má»›i Ä‘Æ°á»£c thá»±c thi. CÆ¡ cháº¿ nÃ y giÃºp háº¡n cháº¿ viá»‡c káº» táº¥n cÃ´ng ghi Ä‘Ã¨ bootloader báº±ng mÃ£ Ä‘á»™c náº¿u cÃ³ lá»— há»•ng.

Vá»‹ trÃ­ trong luá»“ng khá»Ÿi Ä‘á»™ng
Luá»“ng khá»Ÿi Ä‘á»™ng chuáº©n cá»§a má»™t há»‡ thá»‘ng nhÃºng sá»­ dá»¥ng STM32 cÃ³ thá»ƒ mÃ´ táº£ nhÆ° sau:

+-------------------------------+
| Reset / Power On             |
+---------------+---------------+
                |
                v
+-------------------------------+
| ROM Bootloader (ST, optional)|
| - Chá»n boot mode             |
| - Kiá»ƒm tra chÃ¢n BOOT         |
+---------------+---------------+
                |
                v
+-------------------------------+
| User Bootloader (tÃ¹y chá»‰nh)  |
| - Kiá»ƒm tra firmware A/B      |
| - XÃ¡c thá»±c chá»¯ kÃ½ sá»‘         |
| - Rollback náº¿u cáº§n           |
+---------------+---------------+
                |
                v
+-------------------------------+
| á»¨ng dá»¥ng chÃ­nh (firmware)    |
+-------------------------------+
HÃ¬nh 2.1 â€“ SÆ¡ Ä‘á»“ luá»“ng khá»Ÿi Ä‘á»™ng trong há»‡ thá»‘ng STM32 cÃ³ bootloader báº£o máº­t
CÃ¡c bÆ°á»›c khá»Ÿi Ä‘á»™ng cÃ³ thá»ƒ mÃ´ táº£ nhÆ° sau:

Reset hoáº·c cáº¥p nguá»“n â†’ há»‡ thá»‘ng khá»Ÿi Ä‘á»™ng tá»« ROM Bootloader.

ROM Bootloader xÃ¡c Ä‘á»‹nh cháº¿ Ä‘á»™ boot (theo chÃ¢n BOOTx).

Náº¿u chá»n boot tá»« flash: chuyá»ƒn quyá»n Ä‘áº¿n User Bootloader.

User Bootloader:

Kiá»ƒm tra phÃ¢n vÃ¹ng active

Giáº£i mÃ£ firmware (AES)

Kiá»ƒm tra mÃ£ bÄƒm (SHA-256)

XÃ¡c thá»±c chá»¯ kÃ½ sá»‘ (RSA)

Náº¿u há»£p lá»‡ â†’ nháº£y tá»›i á»©ng dá»¥ng chÃ­nh

Náº¿u lá»—i â†’ rollback hoáº·c chá» cáº­p nháº­t má»›i

á»¨ng dá»¥ng chÃ­nh báº¯t Ä‘áº§u cháº¡y.

Trong há»‡ thá»‘ng cÃ³ há»— trá»£ FOTA, bootloader thÆ°á»ng Ä‘Æ°á»£c thiáº¿t káº¿ riÃªng vÃ  chiáº¿m vÃ¹ng flash Ä‘áº§u tiÃªn (thÆ°á»ng tá»« Ä‘á»‹a chá»‰ 0x08000000 trÃªn STM32F4), cÃ³ thá»ƒ Ä‘áº·t cá» kiá»ƒm tra Ä‘á»ƒ quyáº¿t Ä‘á»‹nh:

CÃ³ nÃªn vÃ o cháº¿ Ä‘á»™ cáº­p nháº­t firmware khÃ´ng?

CÃ³ nÃªn boot vÃ o firmware má»›i hay giá»¯ láº¡i báº£n cÅ©?

Náº¿u firmware khÃ´ng há»£p lá»‡, bootloader sáº½ khÃ´ng chuyá»ƒn quyá»n Ä‘iá»u khiá»ƒn, mÃ  cÃ³ thá»ƒ thá»±c hiá»‡n rollback hoáº·c chá» cáº­p nháº­t má»›i.

ğŸ“š TÃ i liá»‡u tham kháº£o:
[1] STMicroelectronics â€“ AN2606, STM32 system memory boot mode.
â†’ Giáº£i thÃ­ch chi tiáº¿t ROM bootloader, lá»±a chá»n BOOT mode.
https://www.st.com/resource/en/application_note/an2606-stm32-microcontroller-system-memory-boot-mode-stmicroelectronics.pdf

[2] Tammy Noergaard, Embedded Systems Architecture, 2nd Edition, Elsevier.
â†’ Tá»•ng quan kiáº¿n trÃºc khá»Ÿi Ä‘á»™ng vÃ  vai trÃ² bootloader trong há»‡ nhÃºng.

==========================2.1.2=======================================================================
\subsubsection{CÃ¡c loáº¡i bootloader trong há»‡ thá»‘ng nhÃºng}
TÃ¹y theo yÃªu cáº§u báº£o máº­t, Ä‘á»™ phá»©c táº¡p vÃ  kiáº¿n trÃºc pháº§n cá»©ng, bootloader trong há»‡ thá»‘ng nhÃºng Ä‘Æ°á»£c phÃ¢n thÃ nh nhiá»u loáº¡i. DÆ°á»›i Ä‘Ã¢y lÃ  phÃ¢n loáº¡i phá»• biáº¿n nháº¥t dá»±a trÃªn chá»©c nÄƒng vÃ  Ä‘á»™ báº£o máº­t.

a) Bootloader cÆ¡ báº£n (basic bootloader)
LÃ  dáº¡ng Ä‘Æ¡n giáº£n nháº¥t, chá»‰ cÃ³ nhiá»‡m vá»¥ chuyá»ƒn quyá»n Ä‘iá»u khiá»ƒn sang á»©ng dá»¥ng chÃ­nh. KhÃ´ng kiá»ƒm tra tÃ­nh toÃ n váº¹n, khÃ´ng há»— trá»£ cáº­p nháº­t hoáº·c rollback. Dáº¡ng nÃ y thÆ°á»ng Ä‘Æ°á»£c tÃ­ch há»£p trong cÃ¡c vi Ä‘iá»u khiá»ƒn nhá», Ã­t tÃ i nguyÃªn hoáº·c trong giai Ä‘oáº¡n Ä‘áº§u phÃ¡t triá»ƒn.

b) Bootloader cÃ³ kháº£ nÄƒng cáº­p nháº­t (FOTA/DFU bootloader)
Cho phÃ©p náº¡p láº¡i firmware thÃ´ng qua UART, USB hoáº·c khÃ´ng dÃ¢y. CÃ³ thá»ƒ bao gá»“m kiá»ƒm tra CRC Ä‘Æ¡n giáº£n hoáº·c phÃ¢n vÃ¹ng Ä‘Ã´i (dual image). Má»™t sá»‘ há»— trá»£ giao thá»©c nhÆ° YMODEM, XMODEM, hoáº·c DFU (Device Firmware Upgrade).

c) Bootloader báº£o máº­t (secure bootloader)
TÃ­ch há»£p cÃ¡c tÃ­nh nÄƒng báº£o máº­t nhÆ°:

XÃ¡c minh chá»¯ kÃ½ sá»‘ (RSA/ECDSA)

MÃ£ hÃ³a firmware (AES)

Kiá»ƒm tra mÃ£ bÄƒm (SHA-256)

Chá»‘ng ghi Ä‘Ã¨ bootloader
ThÆ°á»ng dÃ¹ng trong sáº£n pháº©m thÆ°Æ¡ng máº¡i hoáº·c cÃ¡c thiáº¿t bá»‹ triá»ƒn khai diá»‡n rá»™ng (OTA).

d) Bootloader há»— trá»£ rollback / phÃ¢n vÃ¹ng A/B
Há»‡ thá»‘ng chia lÃ m hai phÃ¢n vÃ¹ng firmware (A vÃ  B). Khi cáº­p nháº­t firmware má»›i, náº¿u kiá»ƒm tra tháº¥t báº¡i (hash sai, chá»¯ kÃ½ khÃ´ng há»£p lá»‡), bootloader cÃ³ thá»ƒ quay láº¡i báº£n cÅ© mÃ  khÃ´ng lÃ m "brick" há»‡ thá»‘ng. ÄÃ¢y lÃ  ká»¹ thuáº­t phá»• biáº¿n trong thiáº¿t káº¿ cáº­p nháº­t an toÃ n.

e) Bootloader Ä‘a cáº¥p (multi-stage boot)
Sá»­ dá»¥ng nhiá»u cáº¥p bootloader, vÃ­ dá»¥:

ROM bootloader (bootloader gá»‘c trong MCU) Ä‘á»ƒ load bootloader ngÆ°á»i dÃ¹ng.

Stage 1 bootloader: kiá»ƒm tra báº£o máº­t cÆ¡ báº£n.

Stage 2 bootloader: xá»­ lÃ½ xÃ¡c minh sÃ¢u hÆ¡n vÃ  chuyá»ƒn quyá»n Ä‘iá»u khiá»ƒn.

CÃ¡c há»‡ thá»‘ng bootloader thÆ°Æ¡ng máº¡i phá»• biáº¿n hiá»‡n nay nhÆ° MCUboot, ST Secure Boot and Secure Firmware Update (SBSFU) hoáº·c NXP secure bootloader Ä‘á»u káº¿t há»£p nhiá»u tÃ­nh nÄƒng nhÆ° xÃ¡c thá»±c RSA, phÃ¢n vÃ¹ng A/B vÃ  rollback. Tuy nhiÃªn, cÃ¡c giáº£i phÃ¡p nÃ y thÆ°á»ng phá»©c táº¡p, Ä‘Ã²i há»i tÃ i nguyÃªn lá»›n, chÆ°a tá»‘i Æ°u cho vi Ä‘iá»u khiá»ƒn cáº¥p tháº¥p.

Trong pháº¡m vi Ä‘á» tÃ i nÃ y, giáº£i phÃ¡p bootloader Ä‘Æ°á»£c Ä‘á» xuáº¥t cÃ³ má»©c Ä‘á»™ báº£o máº­t tÆ°Æ¡ng Ä‘Æ°Æ¡ng secure bootloader thÆ°Æ¡ng máº¡i, nhÆ°ng Ä‘Æ°á»£c thiáº¿t káº¿ nháº¹, phÃ¹ há»£p cho STM32F4, vá»›i Ä‘áº§y Ä‘á»§ cÃ¡c bÆ°á»›c kiá»ƒm tra AES, SHA-256, RSA vÃ  rollback báº±ng phÃ¢n vÃ¹ng flash A/B.

ğŸ“š TÃ i liá»‡u tham kháº£o:
[1] STMicroelectronics â€“ AN4992, STM32 microcontroller system security overview
â†’ Giáº£i thÃ­ch mÃ´ hÃ¬nh secure boot vÃ  phÃ¢n vÃ¹ng A/B trÃªn STM32.
https://www.st.com/resource/en/application_note/an4992

[2] MCUboot Documentation â€“ Linaro
â†’ Kiáº¿n trÃºc bootloader A/B, rollback, xÃ¡c thá»±c.
https://docs.mcuboot.com

[3] Tammy Noergaard, Embedded Systems Architecture, 2nd Edition
â†’ PhÃ¢n loáº¡i bootloader vÃ  kiáº¿n trÃºc há»‡ thá»‘ng nhÃºng.



