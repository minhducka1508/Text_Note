CHÆ¯Æ NG 1.  Tá»”NG QUAN Vá»€ Báº¢O Máº¬T TRONG Há»† THá»NG NHÃšNG VÃ€ IOT. Äá»€ XUáº¤T BOOTLOADER Báº¢O Máº¬T CHO QUÃ TRÃŒNH Cáº¬P NHáº¬T PHáº¦N Má»€M Tá»ª XA 
1.1 Tá»•ng quan há»‡ thá»‘ng nhÃºng, IoT vÃ  nhu cáº§u cáº­p nháº­t pháº§n má»m tá»« xa
1.1.1 Giá»›i thiá»‡u vá» há»‡ thá»‘ng nhÃºng vÃ  IoT
1.1.2 Thá»±c tráº¡ng Ã¡p dá»¥ng cáº­p nháº­t pháº§n má»m tá»« xa

1.2 CÃ¡c thÃ¡ch thá»©c vÃ  cÆ¡ cháº¿ báº£o máº­t trong quÃ¡ trÃ¬nh cáº­p nháº­t firmware
1.2.1 ThÃ¡ch thá»©c trong báº£o máº­t cho FOTA
1.2.2 CÃ¡c cÆ¡ cháº¿ vÃ  thuáº­t toÃ¡n dÃ¹ng trong báº£o máº­t cho FOTA

1.3 Äá» xuáº¥t bootloader báº£o máº­t cho há»‡ thá»‘ng IoT dÃ¹ng vi Ä‘iá»u khiá»ƒn ARM Cortex
1.3.1 SÆ¡ Ä‘á»“ tá»•ng quan giáº£i phÃ¡p.
1.3.2 á»¨ng dá»¥ng cÃ¡c cÆ¡ cháº¿ báº£o máº­t.
1.3.3 Má»¥c tiÃªu thiáº¿t káº¿ (gáº¯n vÃ o cuá»‘i má»¥c nÃ y nhÆ° cÃ´ yÃªu cáº§u).

1.4 Káº¿t luáº­n chÆ°Æ¡ng

CHÆ¯Æ NG 2. CÆ  Sá» LÃ THUYáº¾T Vá»€ BOOTLOADER CHO á»¨NG DUNG FOTA Sá»¬ Dá»¤NG CÃC THUáº¬T TOÃN Báº¢O Máº¬T
2.1. Tá»•ng quan vá» bootloader trong há»‡ thá»‘ng nhÃºng
2.1.1 Vai trÃ² vÃ  vá»‹ trÃ­ cá»§a bootloader trong tiáº¿n trÃ¬nh khá»Ÿi Ä‘á»™ng
2.1.2 CÃ¡c loáº¡i bootloader (basic, secure, dual-app, A/B, rollback...)

2.2. NguyÃªn lÃ½ cáº­p nháº­t firmware tá»« xa (FOTA)
2.2.1 Kiáº¿n trÃºc cÆ¡ báº£n FOTA
2.2.2 YÃªu cáº§u ká»¹ thuáº­t khi triá»ƒn khai trÃªn thiáº¿t bá»‹ nhÃºng

2.3. CÆ¡ sá»Ÿ lÃ½ thuyáº¿t vá» cÃ¡c thuáº­t toÃ¡n báº£o máº­t sá»­ dá»¥ng trong FOTA
2.3.1 Thuáº­t toÃ¡n mÃ£ hÃ³a AES-128
2.3.2 Thuáº­t toÃ¡n bÄƒm SHA-256
2.3.3 Chá»¯ kÃ½ sá»‘ RSA vÃ  cÆ¡ cháº¿ xÃ¡c thá»±c

2.4. MÃ´ hÃ¬nh phÃ¢n vÃ¹ng flash vÃ  cÆ¡ cháº¿ rollback
2.4.1 PhÃ¢n vÃ¹ng A/B vÃ  vÃ¹ng metadata
2.4.2 Ká»¹ thuáº­t khÃ´i phá»¥c khi cáº­p nháº­t tháº¥t báº¡i

2.5. Káº¿t luáº­n chÆ°Æ¡ng

CHÆ¯Æ NG 3. THIáº¾T Káº¾ BOOTLOAER Báº¢O Máº¬T CHO á»¨NG Dá»¤NG FOTA TRÃŠN VI ÄIá»€U KHIá»‚N ARM CORTEX

3.1. PhÃ¢n tÃ­ch yÃªu cáº§u há»‡ thá»‘ng
3.1.1 YÃªu cáº§u pháº§n cá»©ng â€“ STM32F4, ESP32
3.1.2 Giá»›i háº¡n tÃ i nguyÃªn, yÃªu cáº§u báº£o máº­t, tá»‘c Ä‘á»™

3.2. Kiáº¿n trÃºc tá»•ng thá»ƒ há»‡ thá»‘ng cáº­p nháº­t báº£o máº­t
3.2.1 SÆ¡ Ä‘á»“ káº¿t ná»‘i: ESP32 â€“ WiFi â€“ STM32
3.2.2 SÆ¡ Ä‘á»“ dá»¯ liá»‡u: firmware, signature, metadata

3.3. Thiáº¿t káº¿ quy trÃ¬nh cáº­p nháº­t firmware trÃªn thá»±c táº¿
3.3.1 CÃ¡c bÆ°á»›c thá»±c hiá»‡n trÃªn server/gateway
3.3.2 CÃ¡c bÆ°á»›c xá»­ lÃ½ trÃªn bootloader STM32
Â Â Â Â â€“ Giáº£i mÃ£ AES
Â Â Â Â â€“ Kiá»ƒm tra chá»¯ kÃ½ RSA
Â Â Â Â â€“ So sÃ¡nh hash SHA-256
Â Â Â Â â€“ Ghi phÃ¢n vÃ¹ng inactive
Â Â Â Â â€“ Rollback náº¿u lá»—i

3.4. PhÃ¢n vÃ¹ng bá»™ nhá»› vÃ  Ä‘iá»u khiá»ƒn cáº­p nháº­t A/B
3.4.1 SÆ¡ Ä‘á»“ bá»™ nhá»› Flash
3.4.2 Vá»‹ trÃ­ lÆ°u bootloader, firmware A/B, metadata
3.4.3 CÆ¡ cháº¿ chá»n vÃ¹ng active sau reset

3.5. Giao thá»©c truyá»n nháº­n firmware
3.5.1 Giao tiáº¿p UART giá»¯a ESP32 vÃ  STM32
3.5.2 Giao thá»©c gÃ³i tin: cáº¥u trÃºc, checksum, Ä‘á»™ tin cáº­y

3.6. Káº¿t luáº­n chÆ°Æ¡ng

************************************************************************************

\subsubsection{Thá»±c tráº¡ng Ã¡p dá»¥ng cáº­p nháº­t pháº§n má»m tá»« xa}
Trong nhá»¯ng nÄƒm gáº§n Ä‘Ã¢y, cáº­p nháº­t pháº§n má»m tá»« xa (Firmware Over-The-Air â€“ FOTA) Ä‘Ã£ trá»Ÿ thÃ nh má»™t nhu cáº§u táº¥t yáº¿u trong vÃ²ng Ä‘á»i phÃ¡t triá»ƒn vÃ  váº­n hÃ nh thiáº¿t bá»‹ nhÃºng. Khi thiáº¿t bá»‹ Ä‘Æ°á»£c triá»ƒn khai phÃ¢n tÃ¡n á»Ÿ nhiá»u Ä‘á»‹a Ä‘iá»ƒm khÃ¡c nhau â€“ Ä‘Ã´i khi á»Ÿ nhá»¯ng khu vá»±c khÃ´ng thá»ƒ tiáº¿p cáº­n váº­t lÃ½ â€“ viá»‡c cáº­p nháº­t firmware báº±ng cÃ¡p hoáº·c giao diá»‡n trá»±c tiáº¿p lÃ  khÃ´ng thá»±c táº¿. Thay vÃ o Ä‘Ã³, cÃ¡c giáº£i phÃ¡p FOTA giÃºp giáº£m thiá»ƒu chi phÃ­ báº£o trÃ¬, rÃºt ngáº¯n thá»i gian cáº­p nháº­t vÃ  Ä‘áº£m báº£o thiáº¿t bá»‹ luÃ´n Ä‘Æ°á»£c vÃ¡ lá»—i báº£o máº­t ká»‹p thá»i.

Theo kháº£o sÃ¡t tá»« IoT Analytics (2023), cÃ³ Ä‘áº¿n 74% doanh nghiá»‡p phÃ¡t triá»ƒn thiáº¿t bá»‹ IoT coi FOTA lÃ  má»™t yÃªu cáº§u báº¯t buá»™c trong thiáº¿t káº¿ há»‡ thá»‘ng, Ä‘áº·c biá»‡t lÃ  á»Ÿ cÃ¡c lÄ©nh vá»±c nhÆ°: thiáº¿t bá»‹ Ä‘eo y táº¿, cáº£m biáº¿n nÃ´ng nghiá»‡p, cÃ´ng tÆ¡ Ä‘iá»‡n thÃ´ng minh, vÃ  thiáº¿t bá»‹ cÃ´ng nghiá»‡p. Thá»‹ trÆ°á»ng á»©ng dá»¥ng FOTA khÃ´ng chá»‰ dá»«ng á»Ÿ cÃ¡c thiáº¿t bá»‹ IoT tiÃªu dÃ¹ng mÃ  cÃ²n Ä‘Æ°á»£c má»Ÿ rá»™ng máº¡nh máº½ trong ngÃ nh cÃ´ng nghiá»‡p Ã´ tÃ´, nÆ¡i cÃ¡c hÃ£ng nhÆ° Tesla, Ford, Toyota sá»­ dá»¥ng FOTA Ä‘á»ƒ cáº­p nháº­t há»‡ thá»‘ng Ä‘iá»u khiá»ƒn Ä‘á»™ng cÆ¡, giao diá»‡n ngÆ°á»i dÃ¹ng, vÃ  cáº£ pháº§n má»m liÃªn quan Ä‘áº¿n an toÃ n.

TrÃªn thá»±c táº¿, nhiá»u ná»n táº£ng nhÃºng phá»• biáº¿n Ä‘Ã£ tÃ­ch há»£p sáºµn kháº£ nÄƒng há»— trá»£ cáº­p nháº­t tá»« xa. VÃ­ dá»¥, Espressif ESP32 cung cáº¥p OTA API trong bá»™ SDK ESP-IDF, cho phÃ©p cáº­p nháº­t qua Wi-Fi vá»›i tÃ­nh nÄƒng xÃ¡c minh CRC vÃ  phÃ¢n vÃ¹ng A/B. TÆ°Æ¡ng tá»±, STM32 há»— trá»£ bootloader tÃ¹y biáº¿n vÃ  giao tiáº¿p UART/USB, cho phÃ©p cáº­p nháº­t qua pháº§n má»m trung gian nhÆ° STM32CubeProgrammer hoáº·c custom firmware táº£i qua máº¡ng.

Tuy váº­y, viá»‡c triá»ƒn khai FOTA trong mÃ´i trÆ°á»ng nhÃºng váº«n cÃ²n gáº·p nhiá»u háº¡n cháº¿. Má»™t sá»‘ há»‡ thá»‘ng chá»‰ triá»ƒn khai cáº­p nháº­t cÆ¡ báº£n, khÃ´ng cÃ³ kiá»ƒm tra chá»¯ kÃ½ sá»‘ hay mÃ£ hÃ³a ná»™i dung, khiáº¿n firmware cÃ³ thá»ƒ bá»‹ giáº£ máº¡o hoáº·c sá»­a Ä‘á»•i bá»Ÿi cÃ¡c cuá»™c táº¥n cÃ´ng trung gian. NgoÃ i ra, nhiá»u thiáº¿t bá»‹ nhÃºng cÃ³ tÃ i nguyÃªn pháº§n cá»©ng háº¡n cháº¿ (Ã­t RAM, flash nhá», khÃ´ng cÃ³ bá»™ gia tá»‘c mÃ£ hÃ³a pháº§n cá»©ng), khiáº¿n cho viá»‡c tÃ­ch há»£p cÃ¡c thuáº­t toÃ¡n báº£o máº­t tiÃªu chuáº©n nhÆ° AES, SHA hay RSA trá»Ÿ nÃªn phá»©c táº¡p.

BÃªn cáº¡nh yáº¿u tá»‘ ká»¹ thuáº­t, má»™t sá»‘ há»‡ thá»‘ng cÃ²n bá» qua kháº£ nÄƒng rollback â€“ tá»©c quay trá»Ÿ vá» firmware trÆ°á»›c Ä‘Ã³ náº¿u cáº­p nháº­t má»›i tháº¥t báº¡i. Äiá»u nÃ y dáº«n Ä‘áº¿n nguy cÆ¡ thiáº¿t bá»‹ bá»‹ â€œbrickâ€ hoÃ n toÃ n náº¿u firmware má»›i bá»‹ lá»—i hoáº·c quÃ¡ trÃ¬nh cáº­p nháº­t bá»‹ giÃ¡n Ä‘oáº¡n.

Táº¡i Viá»‡t Nam, trong cÃ¡c dá»± Ã¡n IoT quy mÃ´ nhá» vÃ  vá»«a â€“ cháº³ng háº¡n há»‡ thá»‘ng giÃ¡m sÃ¡t cÃ¢y trá»“ng, tráº¡m quan tráº¯c mÃ´i trÆ°á»ng, hoáº·c bá»™ Ä‘iá»u khiá»ƒn thiáº¿t bá»‹ Ä‘iá»‡n â€“ viá»‡c cáº­p nháº­t firmware chá»§ yáº¿u váº«n thá»±c hiá»‡n qua cá»•ng UART thá»§ cÃ´ng, hoáº·c gá»­i file OTA qua giao thá»©c Ä‘Æ¡n giáº£n khÃ´ng mÃ£ hÃ³a. Äiá»u nÃ y cho tháº¥y tiá»m nÄƒng vÃ  sá»± cáº¥p thiáº¿t trong viá»‡c xÃ¢y dá»±ng má»™t giáº£i phÃ¡p bootloader báº£o máº­t, nháº¹, hiá»‡u quáº£, giÃºp cÃ¡c há»‡ thá»‘ng nÃ y tiáº¿p cáº­n Ä‘Æ°á»£c mÃ´ hÃ¬nh FOTA hiá»‡n Ä‘áº¡i, an toÃ n hÆ¡n vÃ  phÃ¹ há»£p vá»›i pháº§n cá»©ng hiá»‡n cÃ³.

/////////////////////
\subsection{CÃ¡c thÃ¡ch thá»©c vÃ  cÆ¡ cháº¿ báº£o máº­t trong quÃ¡ trÃ¬nh cáº­p nháº­t firmware}
\subsubsection{ThÃ¡ch thá»©c trong báº£o máº­t cho FOTA}
Máº·c dÃ¹ FOTA mang láº¡i nhiá»u lá»£i Ã­ch trong váº­n hÃ nh thiáº¿t bá»‹ nhÃºng, quÃ¡ trÃ¬nh cáº­p nháº­t firmware tá»« xa láº¡i tiá»m áº©n nhiá»u rá»§i ro báº£o máº­t nghiÃªm trá»ng náº¿u khÃ´ng cÃ³ biá»‡n phÃ¡p báº£o vá»‡ phÃ¹ há»£p.

Má»™t trong nhá»¯ng thÃ¡ch thá»©c lá»›n nháº¥t lÃ  nguy cÆ¡ firmware bá»‹ giáº£ máº¡o hoáº·c chÃ¨n mÃ£ Ä‘á»™c. Trong trÆ°á»ng há»£p khÃ´ng cÃ³ xÃ¡c thá»±c nguá»“n gá»‘c, thiáº¿t bá»‹ cÃ³ thá»ƒ vÃ´ tÃ¬nh náº¡p vÃ  thá»±c thi má»™t firmware do káº» táº¥n cÃ´ng táº¡o ra, dáº«n Ä‘áº¿n viá»‡c máº¥t kiá»ƒm soÃ¡t thiáº¿t bá»‹ hoáº·c khai thÃ¡c dá»¯ liá»‡u ná»™i bá»™. Theo bÃ¡o cÃ¡o cá»§a Palo Alto Networks (2022), hÆ¡n 55% lá»— há»•ng báº£o máº­t IoT cÃ³ liÃªn quan Ä‘áº¿n firmware vÃ  quy trÃ¬nh cáº­p nháº­t khÃ´ng an toÃ n.

NgoÃ i ra, tÃ­nh toÃ n váº¹n dá»¯ liá»‡u cÅ©ng lÃ  má»™t Ä‘iá»ƒm yáº¿u phá»• biáº¿n. Trong mÃ´i trÆ°á»ng truyá»n khÃ´ng dÃ¢y, viá»‡c nhiá»…u sÃ³ng, máº¥t gÃ³i hoáº·c táº¥n cÃ´ng trung gian (Man-in-the-Middle) cÃ³ thá»ƒ khiáº¿n firmware bá»‹ thay Ä‘á»•i trong quÃ¡ trÃ¬nh truyá»n táº£i. Náº¿u khÃ´ng kiá»ƒm tra tÃ­nh toÃ n váº¹n báº±ng thuáº­t toÃ¡n bÄƒm nhÆ° SHA-256, thiáº¿t bá»‹ cÃ³ thá»ƒ ghi Ä‘Ã¨ firmware lá»—i lÃªn flash vÃ  khÃ´ng thá»ƒ khá»Ÿi Ä‘á»™ng láº¡i.

Má»™t váº¥n Ä‘á» khÃ¡c lÃ  thiáº¿u kháº£ nÄƒng phá»¥c há»“i khi cáº­p nháº­t tháº¥t báº¡i. Nhiá»u thiáº¿t bá»‹ chá»‰ sá»­ dá»¥ng má»™t vÃ¹ng flash cho firmware chÃ­nh. Náº¿u quÃ¡ trÃ¬nh ghi bá»‹ giÃ¡n Ä‘oáº¡n (do máº¥t Ä‘iá»‡n, reset), há»‡ thá»‘ng cÃ³ thá»ƒ bá»‹ â€œbrickâ€. Äiá»u nÃ y Ä‘áº·c biá»‡t nguy hiá»ƒm vá»›i cÃ¡c thiáº¿t bá»‹ triá»ƒn khai cá»‘ Ä‘á»‹nh hoáº·c khÃ´ng cÃ³ giao diá»‡n debug.

Cuá»‘i cÃ¹ng, rÃ o cáº£n quan trá»ng lÃ  háº¡n cháº¿ vá» tÃ i nguyÃªn pháº§n cá»©ng: vi Ä‘iá»u khiá»ƒn phá»• biáº¿n nhÆ° STM32F4 thÆ°á»ng chá»‰ cÃ³ vÃ i trÄƒm KB RAM vÃ  vÃ i MB flash, khÃ´ng Ä‘á»§ Ä‘á»ƒ lÆ°u firmware táº¡m, giáº£i mÃ£ AES hay xÃ¡c thá»±c RSA náº¿u khÃ´ng Ä‘Æ°á»£c tá»‘i Æ°u ká»¹. Do Ä‘Ã³, giáº£i phÃ¡p báº£o máº­t cho FOTA cáº§n Ä‘Æ°á»£c thiáº¿t káº¿ nháº¹, hiá»‡u quáº£, vÃ  phÃ¹ há»£p vá»›i Ä‘áº·c Ä‘iá»ƒm pháº§n cá»©ng háº¡n cháº¿.

\subsubsection{CÃ¡c cÆ¡ cháº¿ vÃ  thuáº­t toÃ¡n dÃ¹ng trong báº£o máº­t cho FOTA}
Äá»ƒ giáº£i quyáº¿t cÃ¡c thÃ¡ch thá»©c nÃªu trÃªn, cÃ¡c há»‡ thá»‘ng FOTA hiá»‡n Ä‘áº¡i thÆ°á»ng tÃ­ch há»£p ba lá»›p báº£o vá»‡ chÃ­nh: báº£o máº­t ná»™i dung, xÃ¡c thá»±c nguá»“n gá»‘c vÃ  Ä‘áº£m báº£o tÃ­nh toÃ n váº¹n.

    MÃ£ hÃ³a ná»™i dung (confidentiality): Dá»¯ liá»‡u firmware thÆ°á»ng Ä‘Æ°á»£c mÃ£ hÃ³a trÆ°á»›c khi truyá»n Ä‘i Ä‘á»ƒ trÃ¡nh bá»‹ lá»™ thÃ´ng tin. Thuáº­t toÃ¡n AES-128 (Advanced Encryption Standard) lÃ  lá»±a chá»n phá»• biáº¿n nhá» Ä‘á»™ an toÃ n cao, tá»‘c Ä‘á»™ nhanh vÃ  kháº£ nÄƒng triá»ƒn khai hiá»‡u quáº£ trÃªn cÃ¡c vi Ä‘iá»u khiá»ƒn ARM Cortex.

    XÃ¡c thá»±c nguá»“n gá»‘c (authenticity): Thiáº¿t bá»‹ cáº§n xÃ¡c minh ráº±ng firmware Ä‘áº¿n tá»« nguá»“n há»£p lá»‡, thÃ´ng qua chá»¯ kÃ½ sá»‘ (digital signature) Ä‘Æ°á»£c táº¡o báº±ng khÃ³a riÃªng vÃ  kiá»ƒm tra báº±ng khÃ³a cÃ´ng khai. RSA lÃ  má»™t trong cÃ¡c thuáº­t toÃ¡n phá»• biáº¿n cho má»¥c Ä‘Ã­ch nÃ y.

    Kiá»ƒm tra toÃ n váº¹n (integrity): TrÆ°á»›c khi ghi firmware vÃ o flash, thiáº¿t bá»‹ tÃ­nh toÃ¡n láº¡i mÃ£ bÄƒm SHA-256 Ä‘á»ƒ so sÃ¡nh vá»›i giÃ¡ trá»‹ hash ban Ä‘áº§u Ä‘Æ°á»£c kÃ½. Náº¿u khÃ´ng trÃ¹ng khá»›p, firmware bá»‹ loáº¡i bá» Ä‘á»ƒ Ä‘áº£m báº£o há»‡ thá»‘ng khÃ´ng thá»±c thi dá»¯ liá»‡u lá»—i.

NgoÃ i ra, viá»‡c phÃ¢n chia bá»™ nhá»› thÃ nh hai phÃ¢n vÃ¹ng firmware (A/B) giÃºp há»‡ thá»‘ng cÃ³ kháº£ nÄƒng phá»¥c há»“i trong trÆ°á»ng há»£p cáº­p nháº­t tháº¥t báº¡i, báº±ng cÃ¡ch giá»¯ láº¡i báº£n firmware á»•n Ä‘á»‹nh trÆ°á»›c Ä‘Ã³. Má»™t sá»‘ vi Ä‘iá»u khiá»ƒn nhÆ° STM32 cÃ²n há»— trá»£ ká»¹ thuáº­t secure boot Ä‘á»ƒ xÃ¡c minh firmware ngay tá»« quÃ¡ trÃ¬nh khá»Ÿi Ä‘á»™ng.

CÃ¡c cÆ¡ cháº¿ trÃªn cáº§n Ä‘Æ°á»£c lá»±a chá»n vÃ  triá»ƒn khai cáº©n tháº­n, phÃ¹ há»£p vá»›i Ä‘áº·c Ä‘iá»ƒm pháº§n cá»©ng cá»¥ thá»ƒ cá»§a há»‡ thá»‘ng Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c sá»± cÃ¢n báº±ng giá»¯a tÃ­nh báº£o máº­t vÃ  hiá»‡u suáº¥t xá»­ lÃ½.

////////////
\subsection{Äá» xuáº¥t bootloader báº£o máº­t cho há»‡ thá»‘ng IoT dÃ¹ng vi Ä‘iá»u khiá»ƒn ARM Cortex}
\subsubsection{SÆ¡ Ä‘á»“ tá»•ng quan giáº£i phÃ¡p}
Giáº£i phÃ¡p Ä‘á» xuáº¥t gá»“m ba thÃ nh pháº§n chÃ­nh:

    Tool mÃ£ hÃ³a trÃªn mÃ¡y tÃ­nh (Python):

NgÆ°á»i phÃ¡t triá»ƒn pháº§n má»m sá»­ dá»¥ng tool Ä‘á»ƒ:

TÃ­nh SHA-256 trÃªn firmware gá»‘c.

KÃ½ mÃ£ bÄƒm báº±ng khÃ³a riÃªng RSA.

MÃ£ hÃ³a toÃ n bá»™ firmware báº±ng AES-128 (cháº¿ Ä‘á»™ CBC).

Táº¡o ra file .bin Ä‘Ã£ mÃ£ hÃ³a + chá»¯ kÃ½ + metadata.

    Gateway trung gian (ESP32):

Káº¿t ná»‘i Internet hoáº·c nháº­n firmware tá»« mÃ¡y tÃ­nh.

Gá»­i file .bin Ä‘Ã£ mÃ£ hÃ³a qua UART tá»›i STM32F4.

KhÃ´ng thá»±c hiá»‡n báº¥t ká»³ xá»­ lÃ½ báº£o máº­t nÃ o.

    Thiáº¿t bá»‹ chÃ­nh (STM32F4):

Nháº­n dá»¯ liá»‡u .bin tá»« ESP32.

Giáº£i mÃ£ firmware báº±ng AES-128.

TÃ­nh láº¡i mÃ£ bÄƒm SHA-256 tá»« dá»¯ liá»‡u sau giáº£i mÃ£.

Giáº£i mÃ£ chá»¯ kÃ½ sá»‘ báº±ng RSA (khÃ³a cÃ´ng khai lÆ°u trong flash).

So sÃ¡nh mÃ£ bÄƒm â†’ náº¿u há»£p lá»‡, ghi vÃ o phÃ¢n vÃ¹ng inactive.

Sau khi ghi xong, cáº­p nháº­t metadata vÃ  chuyá»ƒn boot sang vÃ¹ng firmware má»›i.

SÆ¡ Ä‘á»“ minh há»a tá»•ng quan cÃ³ thá»ƒ Ä‘Æ°á»£c trÃ¬nh bÃ y trong HÃ¬nh 1.3.1 (Gateway â†’ STM32 â†’ xÃ¡c thá»±c â†’ ghi flash).

\subsubsection{á»¨ng dá»¥ng cÃ¡c cÆ¡ cháº¿ báº£o máº­t}
Táº¥t cáº£ quy trÃ¬nh báº£o máº­t Ä‘Æ°á»£c thá»±c hiá»‡n táº¡i thiáº¿t bá»‹ Ä‘Ã­ch (STM32F4):

Giáº£i mÃ£ AES-128: dá»¯ liá»‡u firmware Ä‘Æ°á»£c mÃ£ hÃ³a báº±ng AES (CBC mode) táº¡i tool phÃ¡t hÃ nh. STM32 sá»­ dá»¥ng khÃ³a AES cá»‘ Ä‘á»‹nh Ä‘á»ƒ giáº£i mÃ£.

Kiá»ƒm tra tÃ­nh toÃ n váº¹n: sau giáº£i mÃ£, STM32 tÃ­nh láº¡i SHA-256 vÃ  so sÃ¡nh vá»›i mÃ£ bÄƒm Ä‘Ã£ kÃ½ Ä‘Æ°á»£c gá»­i kÃ¨m.

XÃ¡c thá»±c nguá»“n gá»‘c: chá»¯ kÃ½ sá»‘ RSA trÃªn mÃ£ bÄƒm ban Ä‘áº§u Ä‘Æ°á»£c kiá»ƒm tra báº±ng khÃ³a cÃ´ng khai RSA Ä‘Ã£ lÆ°u trong flash cá»§a STM32.

Ghi flash vÃ  boot: sau xÃ¡c thá»±c, firmware Ä‘Æ°á»£c ghi vÃ o phÃ¢n vÃ¹ng khÃ´ng hoáº¡t Ä‘á»™ng (A hoáº·c B). Náº¿u quÃ¡ trÃ¬nh cáº­p nháº­t thÃ nh cÃ´ng, metadata Ä‘Æ°á»£c cáº­p nháº­t vÃ  bootloader sáº½ chuyá»ƒn sang vÃ¹ng firmware má»›i.

Viá»‡c phÃ¢n tÃ¡ch rÃµ rÃ ng giá»¯a cÃ¡c thÃ nh pháº§n giÃºp há»‡ thá»‘ng vá»«a linh hoáº¡t vá»«a báº£o máº­t, Ä‘á»“ng thá»i phÃ¹ há»£p vá»›i tÃ i nguyÃªn háº¡n cháº¿ cá»§a vi Ä‘iá»u khiá»ƒn.

\subsubsection{Má»¥c tiÃªu thiáº¿t káº¿}
Giáº£i phÃ¡p bootloader báº£o máº­t Ä‘Æ°á»£c xÃ¢y dá»±ng nháº±m Ä‘áº¡t cÃ¡c má»¥c tiÃªu sau:

TÃ­nh báº£o máº­t:

Chá»‰ cháº¥p nháº­n firmware há»£p lá»‡, Ä‘Æ°á»£c kÃ½ sá»‘ vÃ  mÃ£ hÃ³a Ä‘Ãºng Ä‘á»‹nh dáº¡ng.

Báº£o vá»‡ ná»™i dung firmware trong quÃ¡ trÃ¬nh truyá»n táº£i.

PhÃ¡t hiá»‡n sá»­a Ä‘á»•i hoáº·c giáº£ máº¡o firmware.

Kháº£ nÄƒng phá»¥c há»“i vÃ  an toÃ n cáº­p nháº­t:

PhÃ¢n vÃ¹ng A/B, cho phÃ©p rollback khi cáº­p nháº­t tháº¥t báº¡i.

Bootloader Ä‘á»™c láº­p, chá»‘ng ghi Ä‘Ã¨.

Tá»‘i Æ°u tÃ i nguyÃªn há»‡ thá»‘ng:

Táº­n dá»¥ng thÆ° viá»‡n mÃ£ hÃ³a nháº¹ (AES, SHA-256, RSA).

Dung lÆ°á»£ng bootloader nhá» (< 32KB), phÃ¹ há»£p vá»›i STM32F4.

KhÃ´ng yÃªu cáº§u pháº§n cá»©ng há»— trá»£ mÃ£ hÃ³a (dÃ¹ng pháº§n má»m thuáº§n C).

TÃ­nh kháº£ thi vÃ  thá»±c tiá»…n:

CÃ³ thá»ƒ Ã¡p dá»¥ng trong sáº£n pháº©m thÆ°Æ¡ng máº¡i.

PhÃ¹ há»£p vá»›i cÃ¡c thiáº¿t bá»‹ IoT quy mÃ´ vá»«a vÃ  nhá» á»Ÿ Viá»‡t Nam.

Dá»… tÃ­ch há»£p vá»›i quy trÃ¬nh phÃ¡t hÃ nh pháº§n má»m hiá»‡n cÃ³ (tool Python Ä‘Æ¡n giáº£n).

ğŸ“š TÃ i liá»‡u tham kháº£o:
STMicroelectronics â€“ AN4992 â€“ STM32 microcontroller system security overview
â†’ HÆ°á»›ng dáº«n tá»•ng thá»ƒ vá» secure boot, flash layout, báº£o máº­t AES/RSA trÃªn STM32.
https://www.st.com/resource/en/application_note/an4992-stm32-microcontroller-system-security-overview-stmicroelectronics.pdf

NIST FIPS 197 â€“ Advanced Encryption Standard (AES)
â†’ TiÃªu chuáº©n thuáº­t toÃ¡n mÃ£ hÃ³a AES, dÃ¹ng trong quy trÃ¬nh báº£o máº­t.
https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf

////////////////////////
\subsection{Káº¿t luáº­n chÆ°Æ¡ng}
ChÆ°Æ¡ng 1 Ä‘Ã£ trÃ¬nh bÃ y tá»•ng quan vá» há»‡ thá»‘ng nhÃºng, thiáº¿t bá»‹ IoT vÃ  táº§m quan trá»ng cá»§a viá»‡c cáº­p nháº­t pháº§n má»m tá»« xa (FOTA) trong bá»‘i cáº£nh thiáº¿t bá»‹ Ä‘Æ°á»£c triá»ƒn khai phÃ¢n tÃ¡n rá»™ng rÃ£i. CÃ¡c thÃ¡ch thá»©c vá» báº£o máº­t nhÆ° firmware giáº£ máº¡o, máº¥t tÃ­nh toÃ n váº¹n dá»¯ liá»‡u vÃ  cáº­p nháº­t lá»—i Ä‘Ã£ Ä‘Æ°á»£c phÃ¢n tÃ­ch, cho tháº¥y sá»± cáº§n thiáº¿t pháº£i tÃ­ch há»£p cÃ¡c cÆ¡ cháº¿ báº£o máº­t trong quÃ¡ trÃ¬nh cáº­p nháº­t.

Tá»« Ä‘Ã³, Ä‘á» tÃ i Ä‘Ã£ Ä‘á» xuáº¥t má»™t giáº£i phÃ¡p bootloader báº£o máº­t dÃ nh cho dÃ²ng vi Ä‘iá»u khiá»ƒn ARM Cortex, vá»›i sá»± tÃ¡ch biá»‡t rÃµ rÃ ng giá»¯a ba thÃ nh pháº§n: cÃ´ng cá»¥ mÃ£ hÃ³a phÃ¡t hÃ nh firmware, gateway trung gian vÃ  thiáº¿t bá»‹ Ä‘Ã­ch (STM32F4). ToÃ n bá»™ quÃ¡ trÃ¬nh xÃ¡c thá»±c, giáº£i mÃ£ vÃ  ghi flash Ä‘Æ°á»£c thá»±c hiá»‡n trá»±c tiáº¿p táº¡i bootloader, giÃºp Ä‘áº£m báº£o an toÃ n trong mÃ´i trÆ°á»ng khÃ´ng Ä‘Ã¡ng tin cáº­y, Ä‘á»“ng thá»i phÃ¹ há»£p vá»›i tÃ i nguyÃªn háº¡n cháº¿ cá»§a há»‡ thá»‘ng nhÃºng.

Pháº§n tiáº¿p theo (ChÆ°Æ¡ng 2) sáº½ trÃ¬nh bÃ y cÆ¡ sá»Ÿ lÃ½ thuyáº¿t liÃªn quan Ä‘áº¿n cÃ¡c thÃ nh pháº§n ká»¹ thuáº­t trong giáº£i phÃ¡p, bao gá»“m kiáº¿n trÃºc bootloader, cÃ¡c thuáº­t toÃ¡n mÃ£ hÃ³a/bÄƒm/xÃ¡c thá»±c, cÅ©ng nhÆ° tá»• chá»©c bá»™ nhá»› vÃ  luá»“ng cáº­p nháº­t firmware an toÃ n.


*********************************************************************************
